{% block content %}
<div class="botoes">
    <div>
        <button id="botao-add-cliente">
            <span id="botao-add-cliente-icon" class="material-icons">person_add</span>
            <span id="botao-add-cliente-texto">adicionar cliente</span>
        </button>
    </div>
    <div id="botao-pesquisar">
        <span class='material-icons' style="cursor: default; margin-top: 2px; margin-left:2px;">search</span>
        <input id="pesquisacliente" type="search" name="" placeholder="pesquisar cliente">
    </div>
</div>

<div class="app-cards">
    {% for usuario in usuarios %}
    <div class="app-card">
        <div class="card-dados-cliente">
            <p style="font-weight: bold;">{{ usuario.nome }} {{ usuario.sobrenome }}</p>
            <!-- <p>CPF: {{ usuario.cpf }}</p> -->
            <p>telefone: {{ usuario.telefone }}</p>
            <p>{{ usuario.rua }}</p>
        </div>
        <div style="display: flex; justify-content: end; padding-right: 10px;">
            <button class="botao-clientes" data-bs-toggle="modal" data-bs-target="#modalConfirmarDelete"
                onclick="openModalDeleteUser('{{ usuario.pk }}', '{{ usuario.nome }}', '{{ usuario.sobrenome }}', '{{ usuario.telefone }}');">
                <span class="material-icons">delete_outline</span>
                <span class="label-botao-clientes">excluir</span>
            </button>
            <button class="botao-clientes" onclick="editar('{{usuario.pk}}')">
                <span class="material-icons">edit</span>
                <span class="label-botao-clientes">editar</span>
            </button>
            <button class="botao-clientes">
                <span class="material-icons">menu_book</span>
                <span class="label-botao-clientes">novo pedido</span>
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock%}

<script>
function openModalDeleteUser(pk, nome, sobrenome) {
    $('#cliente-nome').html(nome);
    $('#cliente-sobrenome').html(sobrenome);
    $('#form-delete').attr('action', '/clientes/delete/' + escape(pk));
}

function editar(pk) {
    window.location.href = "/clientes/" + pk;
}

$(document).ready(function(){
	$("#botao-add-cliente").click(function() {
		window.location.href = "/clientes/cadastro";
	});

  //setup before functions
  var typingTimer;                //timer identifier
  var doneTypingInterval = 500;  //time in ms, 5 second for example
  var $input = $('#pesquisacliente');

  //on keyup, start the countdown
  $input.on('keyup', function () {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(doneTyping, doneTypingInterval);
  });

  //on keydown, clear the countdown 
  $input.on('keydown', function () {
    clearTimeout(typingTimer);
  });

  //user is "finished typing," do something
  function doneTyping () {
    $.ajax({
      url: '/clientes/busca',
      method: 'GET',
      data: {"pesquisa": $input.val()}
    }).done(function(resp){
      $(".app-cards").empty();
      var string = ``;
      $(resp.clientes).each(function(index){
        var cliente = resp.clientes[index];
        string += `<div class="app-card">
        <div class="card-dados-cliente">
            <p style="font-weight: bold;">${cliente.nome} ${cliente.sobrenome}</p>
            <p>telefone: ${cliente.telefone}</p>
            <p>${cliente.rua}, ${cliente.numero}</p>
        </div>
        <div style="display: flex; justify-content: end; padding-right: 10px;">
            <button class="botao-clientes" data-bs-toggle="modal" data-bs-target="#modalConfirmarDelete"
                onclick="openModalDeleteUser('${cliente.pk}', '${cliente.nome}', '${cliente.sobrenome}', '${cliente.telefone}');">
                <span class="material-icons">delete_outline</span>
                <span class="label-botao-clientes">excluir</span>
            </button>
            <button class="botao-clientes" onclick="editar('${cliente.pk}')">
                <span class="material-icons">edit</span>
                <span class="label-botao-clientes">editar</span>
            </button>
            <button class="botao-clientes">
                <span class="material-icons">menu_book</span>
                <span class="label-botao-clientes">novo pedido</span>
            </button>
        </div>
    </div>`;
  });
    $(".app-cards").append(string);
    });
  }
});
</script>

  <div class="modal" tabindex="-1" id="modalConfirmarDelete"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Excluir Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Deseja mesmo excluir o cliente
            <span id="cliente-nome"></span>
            <span id="cliente-sobrenome"></span>
            ?
          </p>
        </div>
        <div class="modal-footer">
          <form method="get" action="/none" id="form-delete">
            <input type="hidden" name="do-delete" value="true"/>
            <button type="submit" class="btn btn-danger">Sim</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">NÃ£o</button>
          </form>
        </div>
      </div>
    </div>
  </div>